<% actions = local_assigns.fetch(:actions, []) %>
<% row_actions = actions - [:create] %>
<% model_class = rows.respond_to?(:klass) ? rows.klass : rows.first&.class %>
<% search_url = local_assigns[:search_url] %>
<% create_url = local_assigns[:create_url] %>
<% create_label = local_assigns.fetch(:create_label, "Create Record") %>
<% destroy_confirm = local_assigns.fetch(:destroy_confirm, "Are you sure?") %>
<% destroy_label = local_assigns.fetch(:destroy_label, "Delete") %>
<% view_path = local_assigns[:view_path] %>
<% pagy = local_assigns[:pagy] %>
<% frame_id = local_assigns.fetch(:frame_id, "table_frame") %>
<% search_param = local_assigns.fetch(:search_param, :query) %>
<% page_param = local_assigns.fetch(:page_param, :page) %>
<% pagination_frame = local_assigns.fetch(:pagination_frame, frame_id) %>
<% sortable_url = local_assigns[:sortable_url] %>
<% destroy_frame = local_assigns[:destroy_frame] %>

<% create_href = create_url || (actions.include?(:create) && model_class ? new_polymorphic_path(model_class) : nil) %>

<% if create_href || search_url %>
  <div class="flex items-center justify-between mb-2">
    <div class="w-full max-w-sm">
      <% if search_url %>
        <%= form_with url: search_url, method: :get, data: { turbo_frame: frame_id, turbo_action: "advance" } do |form| %>
          <div class="relative">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
              <%= lucide_icon("search", class: "h-4 w-4 text-gray-400") %>
            </div>
            <%= form.search_field search_param, value: params[search_param], placeholder: "Search records...", class: "w-full rounded-md border border-gray-300 bg-white pl-9 pr-3 py-2 text-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500", oninput: "this.form.requestSubmit()" %>
          </div>
        <% end %>
      <% end %>
    </div>
    <div>
      <% if create_href %>
        <%= render "shared/button", label: create_label, href: create_href, icon: "plus" %>
      <% end %>
    </div>
  </div>
<% end %>

<% table_content = capture do %>
  <div class="overflow-x-auto rounded-lg border border-gray-200">
    <% if rows.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <% if sortable_url %>
              <th class="w-10 px-3 py-3"></th>
            <% end %>
            <% columns.each do |column| %>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= column[:header] %>
              </th>
            <% end %>
            <% if row_actions.any? %>
              <th class="px-6 py-3"></th>
            <% end %>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200"
          <% if sortable_url %>
            data-controller="sortable"
            data-sortable-url-value="<%= sortable_url %>"
            data-sortable-handle-value=".drag-handle"
            data-sortable-fallback-value="true"
          <% end %>
        >
          <% rows.each do |row| %>
            <tr class="even:bg-gray-50" <% if sortable_url %>data-sortable-id="<%= row.id %>"<% end %>>
              <% if sortable_url %>
                <td class="w-10 px-3 py-2.5 cursor-grab active:cursor-grabbing drag-handle">
                  <%= lucide_icon("grip-vertical", class: "h-4 w-4 text-gray-400") %>
                </td>
              <% end %>
              <% columns.each do |column| %>
                <td class="px-6 py-2.5 text-sm text-gray-900 whitespace-nowrap">
                  <% value = column[:accessor].is_a?(Symbol) ? row.public_send(column[:accessor]) : column[:accessor].call(row) %>
                  <% if column[:link] %>
                    <%= link_to value, column[:link].call(row), class: "text-blue-600 hover:underline transition-colors", data: { turbo_frame: "_top" } %>
                  <% else %>
                    <%= value %>
                  <% end %>
                </td>
              <% end %>
              <% if row_actions.any? %>
                <td class="px-6 py-2.5 text-sm whitespace-nowrap text-right">
                  <div class="inline-flex items-center gap-3">
                    <% row_actions.each do |action| %>
                      <% case action
                         when :view %>
                        <%= link_to "View", view_path ? view_path.call(row) : polymorphic_path(row), class: "inline-block px-3 py-1 text-xs font-medium rounded-md border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition-colors", data: { turbo_frame: "_top" } %>
                      <% when :edit %>
                        <%= link_to "Edit", edit_polymorphic_path(row), class: "inline-block px-3 py-1 text-xs font-medium rounded-md border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition-colors", data: { turbo_frame: "_top" } %>
                      <% when :destroy %>
                        <% destroy_form_data = { turbo_confirm: destroy_confirm } %>
                        <% destroy_form_data[:turbo_frame] = destroy_frame if destroy_frame %>
                        <%= button_to destroy_label, polymorphic_path(row), method: :delete, class: "px-3 py-1 text-xs font-medium rounded-md border border-red-300 text-red-600 bg-white hover:bg-red-50 transition-colors cursor-pointer", form: { data: destroy_form_data } %>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="bg-white px-6 py-12 text-center text-sm text-gray-500">
        No records found.
      </div>
    <% end %>
  </div>

  <% if pagy %>
    <%= render "shared/pagination", pagy: pagy, frame_id: pagination_frame || "table_frame", page_param: page_param %>
  <% end %>
<% end %>

<% if frame_id %>
  <%= turbo_frame_tag frame_id do %><%= table_content %><% end %>
<% else %>
  <%= table_content %>
<% end %>
