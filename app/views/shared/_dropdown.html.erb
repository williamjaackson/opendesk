<%# locals: (options:, form: nil, field: nil, name: nil, label: nil, selected: nil, placeholder: "Select...", required: false, searchable: false, input_data: {}, autofocus: false, inline: false) %>
<% selected_option = options.find { |o| o[1].to_s == selected.to_s } %>
<% errors = form&.object&.errors&.[](field) || [] %>
<% field_name = name || (form && field ? form.field_name(field) : nil) %>

<%= tag.div class: ("mb-4" unless inline) do %>
  <% unless inline %>
    <%= form.label field, class: "block text-sm font-medium text-gray-700 mb-1" do %>
      <%= label || field.to_s.humanize %><% if required %><span class="text-red-500 ml-0.5">*</span><% end %>
    <% end %>
  <% end %>

  <div data-controller="dropdown" data-action="keydown->dropdown#keydown" class="relative">
    <% if form && field %>
      <%= form.hidden_field field, data: { dropdown_target: "input" }.merge(input_data) %>
    <% else %>
      <input type="hidden" name="<%= field_name %>" value="<%= selected %>" data-dropdown-target="input">
    <% end %>

    <div class="relative">
      <input type="text" readonly data-action="click->dropdown#toggle" data-dropdown-target="button"
        placeholder="<%= placeholder %>" value="<%= selected_option ? selected_option[0] : '' %>"
        <%= "autofocus" if autofocus %>
        class="block w-full rounded-md border <%= errors.any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500' %> bg-white px-3 py-2 pr-8 text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none focus:ring-1 cursor-pointer select-none" />
      <%= lucide_icon("chevron-down", class: "absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none") %>
    </div>

    <div data-dropdown-target="menu" class="hidden absolute z-10 mt-1 w-full rounded-md border border-gray-200 bg-white shadow-lg max-h-60 overflow-y-auto">
      <% if searchable %>
        <div class="sticky top-0 bg-white border-b border-gray-200 p-1.5">
          <input type="text" data-dropdown-target="search" data-action="input->dropdown#filter"
            placeholder="Search..." class="w-full rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500" />
        </div>
      <% end %>
      <div class="py-1">
      <% options.each do |option_label, option_value, option_data, option_icon| %>
        <button type="button" tabindex="-1" data-action="dropdown#select" data-value="<%= option_value %>" data-label="<%= option_label %>"<% (option_data || {}).each do |attr, val| %> <%= attr %>="<%= val %>"<% end %>
          class="flex items-center justify-between w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer select-none">
          <span class="flex items-center gap-1.5">
            <% if option_icon %><%= lucide_icon(option_icon, class: "h-3.5 w-3.5 text-gray-400") %><% end %>
            <%= option_label %>
          </span>
          <span data-check class="<%= 'invisible' unless option_value.to_s == selected.to_s %>">
            <%= lucide_icon("check", class: "h-4 w-4 text-gray-900") %>
          </span>
        </button>
      <% end %>
      </div>
    </div>
  </div>
  <% errors.each do |error| %>
    <p class="mt-1 text-sm text-red-600"><%= error %></p>
  <% end %>
<% end %>
