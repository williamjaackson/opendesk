<div class="max-w-4xl mx-auto py-8 px-4">
  <%= render "shared/breadcrumbs", crumbs: [[@custom_table.name, table_path(@custom_table)], ["Edit", edit_table_path(@custom_table)], ["Import", nil]] %>
  <%= render "shared/page_heading", title: "Import CSV" %>

  <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
    <div class="mb-4">
      <h2 class="text-sm font-medium text-gray-900 mb-2">Before importing</h2>
      <ul class="text-sm text-gray-600 space-y-1">
        <li>Your CSV should have column headers in the first row</li>
        <li>You can map columns to existing table columns or create new ones</li>
        <li>Large files (500+ rows) will be processed in the background</li>
      </ul>
    </div>

    <% if @columns.any? %>
      <div class="mb-4">
        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Template preview</p>
        <div class="overflow-x-auto border border-gray-200 rounded-md">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
              <tr>
                <% @columns.each do |column| %>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500"><%= column.name %></th>
                <% end %>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr>
                <% @columns.each do |column| %>
                  <td class="px-3 py-2 text-gray-400 italic"><%= sample_value_for_type(column.column_type) %></td>
                <% end %>
              </tr>
              <tr>
                <% @columns.each do |column| %>
                  <td class="px-3 py-2 text-gray-400 italic"><%= sample_value_for_type(column.column_type, variant: 2) %></td>
                <% end %>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

    <div class="flex items-center gap-2 text-sm text-gray-500">
      <%= lucide_icon("download", class: "h-4 w-4") %>
      <span>Need a starting point?</span>
      <%= link_to "Download template CSV", template_table_path(@custom_table, format: :csv), class: "text-gray-900 underline hover:text-gray-700", data: { turbo: false } %>
    </div>
  </div>

  <%= form_with model: @csv_import, url: table_csv_imports_path(@custom_table), html: { novalidate: true }, data: { controller: "file-input" } do |form| %>
    <% file_errors = @csv_import.errors[:file] %>
    <div class="mb-6">
      <%= form.label :file, class: "block text-sm font-medium text-gray-700 mb-2" do %>
        CSV file<span class="text-red-500 ml-0.5">*</span>
      <% end %>
      <%= form.file_field :file, accept: ".csv,text/csv", required: true,
        data: { file_input_target: "input", action: "change->file-input#changed" },
        class: "sr-only" %>
      <div class="flex items-center gap-3">
        <button type="button" data-action="click->file-input#select"
          class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 transition-colors cursor-pointer select-none <%= 'border-red-300' if file_errors.any? %>">
          <%= lucide_icon("upload", class: "h-4 w-4") %>
          Choose file
        </button>
        <span data-file-input-target="filename" class="text-sm text-gray-400">No file selected</span>
      </div>
      <% file_errors.each do |error| %>
        <p class="mt-1 text-sm text-red-600"><%= error %></p>
      <% end %>
    </div>

    <div class="flex items-center gap-3">
      <button type="submit" disabled data-file-input-target="submit"
        class="inline-flex items-center gap-1.5 px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-md hover:bg-gray-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 transition-colors select-none opacity-50 cursor-not-allowed">
        <%= lucide_icon("arrow-right", class: "h-4 w-4") %>
        Continue
      </button>
      <%= render "shared/button", style: "ghost", label: "Cancel", href: edit_table_path(@custom_table) %>
    </div>
  <% end %>
</div>
