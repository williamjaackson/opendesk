<div class="max-w-4xl mx-auto py-8 px-4">
  <%= render "shared/breadcrumbs", crumbs: [[@custom_table.name, table_path(@custom_table)], ["Edit", edit_table_path(@custom_table)], ["Import", nil]] %>
  <%= render "shared/page_heading", title: "Import CSV" %>

  <div class="space-y-8">
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-1">Upload file</h2>
      <p class="text-sm text-gray-500 mb-4">Upload a CSV file with column headers in the first row. You'll map columns in the next step.</p>

      <%= form_with model: @csv_import, url: table_csv_imports_path(@custom_table), html: { novalidate: true }, data: { controller: "file-input" } do |form| %>
        <% file_errors = @csv_import.errors[:file] %>

        <%= form.file_field :file, accept: ".csv,text/csv", required: true,
          data: { file_input_target: "input", action: "change->file-input#changed" },
          class: "sr-only" %>

        <div class="flex items-center gap-3 mb-6">
          <button type="button" data-action="click->file-input#select"
            class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 transition-colors cursor-pointer select-none <%= 'border-red-300' if file_errors.any? %>">
            <%= lucide_icon("file-up", class: "h-4 w-4") %>
            Choose file
          </button>
          <span data-file-input-target="filename" class="text-sm text-gray-500">No file selected</span>
        </div>

        <% file_errors.each do |error| %>
          <p class="mb-4 text-sm text-red-600"><%= error %></p>
        <% end %>

        <div class="flex items-center gap-3">
          <button type="submit" disabled data-file-input-target="submit"
            class="inline-flex items-center gap-1.5 px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-md hover:bg-gray-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 transition-colors select-none opacity-50 cursor-not-allowed">
            Continue
            <%= lucide_icon("arrow-right", class: "h-4 w-4") %>
          </button>
          <%= render "shared/button", style: "ghost", label: "Cancel", href: edit_table_path(@custom_table) %>
        </div>
      <% end %>
    </section>

    <% if @columns.any? %>
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Expected format</h2>
        <p class="text-sm text-gray-500 mb-4">Your CSV should have columns matching your table structure. New columns can be created during import.</p>

        <div class="overflow-x-auto border border-gray-200 rounded-md">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
              <tr>
                <% @columns.each do |column| %>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= column.name %></th>
                <% end %>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr>
                <% @columns.each do |column| %>
                  <td class="px-3 py-2 text-gray-400 italic"><%= sample_value_for_type(column.column_type) %></td>
                <% end %>
              </tr>
              <tr>
                <% @columns.each do |column| %>
                  <td class="px-3 py-2 text-gray-400 italic"><%= sample_value_for_type(column.column_type, variant: 2) %></td>
                <% end %>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mt-4 flex items-center gap-2 text-sm text-gray-500">
          <%= lucide_icon("download", class: "h-4 w-4") %>
          <span>Need a starting point?</span>
          <%= link_to "Download template", template_table_path(@custom_table, format: :csv), class: "text-gray-900 underline hover:text-gray-700", data: { turbo: false } %>
        </div>
      </section>
    <% end %>
  </div>
</div>
