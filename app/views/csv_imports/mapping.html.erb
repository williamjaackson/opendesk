<div class="max-w-4xl mx-auto py-8 px-4">
  <%= render "shared/breadcrumbs", crumbs: [[@custom_table.name, table_path(@custom_table)], ["Import CSV", nil]] %>
  <%= render "shared/page_heading", title: "Map columns" %>

  <% if @preview_rows.any? %>
    <div class="bg-white rounded-lg border border-gray-200 mb-6 overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
        <h2 class="text-sm font-medium text-gray-700">Preview (first <%= @preview_rows.size %> rows)</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <% @headers.each do |header| %>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= header %></th>
              <% end %>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @preview_rows.each do |row| %>
              <tr>
                <% @headers.each do |header| %>
                  <td class="px-4 py-2 text-gray-700 whitespace-nowrap max-w-xs truncate"><%= row[header] %></td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%= form_with url: table_csv_import_path(@custom_table, @csv_import), method: :patch, html: { novalidate: true } do |form| %>
    <div class="bg-white rounded-lg border border-gray-200 mb-6">
      <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
        <h2 class="text-sm font-medium text-gray-700">Column mapping</h2>
      </div>
      <div class="p-4 space-y-4">
        <% @headers.each do |header| %>
          <div class="flex items-center gap-4">
            <div class="w-1/3">
              <span class="text-sm font-medium text-gray-700"><%= header %></span>
            </div>
            <div class="w-8 text-center text-gray-400">
              <%= lucide_icon("arrow-right", class: "h-4 w-4 inline") %>
            </div>
            <div class="flex-1">
              <select name="column_mapping[<%= header %>]" class="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:border-gray-500 focus:ring-gray-500">
                <option value="">Skip this column</option>
                <option value="__id__" <%= header.downcase == "id" ? "selected" : "" %>>Record ID (for updates)</option>
                <optgroup label="Columns">
                  <% @columns.each do |column| %>
                    <% next if column.computed? %>
                    <% auto_selected = header.downcase == column.name.downcase %>
                    <option value="<%= column.id %>" <%= auto_selected ? "selected" : "" %>><%= column.name %></option>
                  <% end %>
                </optgroup>
                <% if @relationships.any? %>
                  <optgroup label="Relationships (link by ID)">
                    <% @relationships.each do |rel| %>
                      <% rel_name = rel.source_table_id == @custom_table.id ? rel.name : rel.inverse_name %>
                      <% auto_selected = header.downcase.include?(rel_name.downcase) && header.downcase.include?("id") %>
                      <option value="rel:<%= rel.id %>" <%= auto_selected ? "selected" : "" %>><%= rel_name %> (ID)</option>
                    <% end %>
                  </optgroup>
                <% end %>
              </select>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 mb-6">
      <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
        <h2 class="text-sm font-medium text-gray-700">Duplicate handling</h2>
      </div>
      <div class="p-4">
        <p class="text-sm text-gray-600 mb-4">When a CSV row contains an ID that matches an existing record:</p>
        <div class="space-y-3">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="radio" name="duplicate_handling" value="create" <%= @csv_import.duplicate_handling == "create" ? "checked" : "" %> class="h-4 w-4 text-gray-900 focus:ring-gray-500 border-gray-300">
            <div>
              <span class="text-sm font-medium text-gray-700">Create new records</span>
              <p class="text-sm text-gray-500">Ignore IDs and always create new records</p>
            </div>
          </label>
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="radio" name="duplicate_handling" value="skip" <%= @csv_import.duplicate_handling == "skip" ? "checked" : "" %> class="h-4 w-4 text-gray-900 focus:ring-gray-500 border-gray-300">
            <div>
              <span class="text-sm font-medium text-gray-700">Skip existing</span>
              <p class="text-sm text-gray-500">Skip rows with IDs that already exist</p>
            </div>
          </label>
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="radio" name="duplicate_handling" value="update" <%= @csv_import.duplicate_handling == "update" ? "checked" : "" %> class="h-4 w-4 text-gray-900 focus:ring-gray-500 border-gray-300">
            <div>
              <span class="text-sm font-medium text-gray-700">Update existing</span>
              <p class="text-sm text-gray-500">Update records with matching IDs, create new for unmatched</p>
            </div>
          </label>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <%= render "shared/button", label: "Start import", form: form %>
      <%= link_to "Cancel", table_path(@custom_table), class: "inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-gray-500 rounded-md hover:text-gray-700 hover:bg-gray-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 transition-colors cursor-pointer select-none", data: { turbo_method: :delete, turbo_confirm: "Cancel this import?" } %>
    </div>
  <% end %>
</div>
