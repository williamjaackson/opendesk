<div class="max-w-4xl mx-auto py-8 px-4">
  <%= render "shared/breadcrumbs", crumbs: [[@custom_table.name, table_path(@custom_table)], ["Edit", edit_table_path(@custom_table)]] %>
  <%= render "shared/page_heading", title: "Edit column" %>

  <div class="space-y-8">
    <%= form_with model: @custom_column, url: table_column_path(@custom_table, @custom_column), html: { novalidate: true } do |form| %>
      <%= render "shared/form_input", form: form, field: :name, label: "Column name", options: { required: true, autofocus: true, placeholder: "e.g. Email, Phone, Status" } %>

      <div class="mb-4">
        <span class="block text-sm font-medium text-gray-700 mb-1">Type</span>
        <span class="block w-full rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500"><%= @custom_column.column_type.capitalize %></span>
      </div>

      <% if @custom_column.column_type == "select" %>
        <div data-controller="select-source" data-select-source-tables-value="<%= @tables_json %>">
          <%= render "shared/radio_group", form: form, field: :select_source, label: "Select options source",
            selected: @custom_column.select_source,
            options: [["Manual", "manual"], ["Linked to table", "linked"]],
            input_data: { action: "change->select-source#sourceChanged", select_source_target: "sourceInput" } %>

          <div data-select-source-target="manualOptions" class="<%= "hidden" if @custom_column.select_source == "linked" %>">
            <% options_errors = @custom_column.errors[:options_text] %>
            <div class="mb-4">
              <%= form.label :options_text, "Options (one per line)", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_area :options_text, rows: 4, placeholder: "Active\nInactive\nPending", class: "block w-full rounded-md border #{options_errors.any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500'} bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1" %>
              <% options_errors.each do |error| %>
                <p class="mt-1 text-sm text-red-600"><%= error %></p>
              <% end %>
            </div>
          </div>

          <div data-select-source-target="linkedOptions" class="<%= "hidden" if @custom_column.select_source == "manual" %>">
            <%= render "shared/dropdown", form: form, field: :linked_table_id, label: "Table",
              searchable: true, selected: @custom_column.linked_table_id,
              options: Current.organisation.custom_tables.map { |t| [t.name, t.id] },
              input_data: { action: "change->select-source#tableChanged", select_source_target: "linkedTableInput" } %>

            <% column_options = @custom_column.linked_column ?
                 @custom_column.linked_column.custom_table.custom_columns.map { |c| [c.name, c.id] } : [] %>
            <%= render "shared/dropdown", form: form, field: :linked_column_id, label: "Column",
              searchable: true, selected: @custom_column.linked_column_id,
              options: column_options,
              input_data: { select_source_target: "linkedColumnInput" } %>
          </div>
        </div>
      <% end %>

      <% if @custom_column.column_type.in?(%w[text number]) %>
        <% regex_enabled = @custom_column.regex_pattern.present? %>
        <div class="mb-4" data-controller="regex-toggle">
          <input type="hidden" value="<%= regex_enabled ? '1' : '0' %>" data-regex-toggle-target="input">
          <div tabindex="0" role="checkbox" aria-checked="<%= regex_enabled %>" aria-label="Custom validation"
            data-action="click->regex-toggle#toggle keydown->regex-toggle#keydown"
            class="inline-flex items-center gap-2 cursor-pointer select-none group">
            <span data-regex-toggle-target="box"
              class="flex shrink-0 items-center justify-center h-5 w-5 rounded border transition-colors
                <%= regex_enabled ? 'bg-gray-900 border-gray-900' : 'bg-white border-gray-300' %>
                group-focus:ring-2 group-focus:ring-gray-500 group-focus:ring-offset-1">
              <svg data-checkmark viewBox="0 0 12 10" fill="none" class="h-3 w-3 text-white <%= 'invisible' unless regex_enabled %>">
                <path d="M1 5.5L4 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="text-sm font-medium text-gray-700">Custom validation</span>
          </div>

          <div data-regex-toggle-target="fields" class="<%= 'hidden' unless regex_enabled %> mt-3 space-y-3">
            <div>
              <%= form.label :regex_pattern, class: "block text-sm font-medium text-gray-700 mb-1" do %>Regex pattern<span class="text-red-500 ml-0.5">*</span><% end %>
              <%= form.text_field :regex_pattern, required: regex_enabled, placeholder: '^\d{3}-\d{4}$', class: "block w-full rounded-md border #{@custom_column.errors[:regex_pattern].any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500'} bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1" %>
              <% @custom_column.errors[:regex_pattern].each do |error| %>
                <p class="mt-1 text-sm text-red-600"><%= error %></p>
              <% end %>
            </div>
            <div>
              <%= form.label :regex_label, class: "block text-sm font-medium text-gray-700 mb-1" do %>Validation name<span class="text-red-500 ml-0.5">*</span><% end %>
              <%= form.text_field :regex_label, required: regex_enabled, placeholder: "Phone Number", class: "block w-full rounded-md border #{@custom_column.errors[:regex_label].any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500'} bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1" %>
              <% @custom_column.errors[:regex_label].each do |error| %>
                <p class="mt-1 text-sm text-red-600"><%= error %></p>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <% unless @custom_column.column_type == "boolean" %>
        <%= render "shared/checkbox", form: form, field: :required, label: "Required column" %>
      <% end %>
      <%= render "shared/checkbox", form: form, field: :show_on_preview, label: "Show on preview" %>

      <div class="flex items-center gap-3">
        <%= render "shared/button", label: "Save changes", form: form %>
        <%= render "shared/button", style: "ghost", label: "Cancel", href: edit_table_path(@custom_table) %>
      </div>
    <% end %>

    <%= render "shared/danger_zone",
      description: "Deleting this column will permanently remove all its values.",
      path: table_column_path(@custom_table, @custom_column),
      button_label: "Delete column",
      confirm: "Are you sure you want to delete this column? This cannot be undone." %>
  </div>
</div>
