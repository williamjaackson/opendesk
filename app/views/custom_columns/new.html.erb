<div class="max-w-4xl mx-auto py-8 px-4">
  <%= render "shared/breadcrumbs", crumbs: [[@custom_table.name, table_path(@custom_table)], ["Edit", edit_table_path(@custom_table)]] %>
  <%= render "shared/page_heading", title: "New column" %>

  <%= form_with model: @custom_column, url: table_columns_path(@custom_table), html: { novalidate: true }, data: { controller: "column-options" } do |form| %>
    <%= render "shared/form_input", form: form, field: :name, label: "Column name", options: { required: true, autofocus: true, placeholder: "e.g. Email, Phone, Status" } %>

    <%= render "shared/dropdown", form: form, field: :column_type, label: "Type", required: true,
      searchable: true, selected: @custom_column.column_type,
      options: [["Text", "text"], ["Number", "number"], ["Decimal", "decimal"], ["Email", "email"], ["Boolean", "boolean"], ["Date", "date"], ["Time", "time"], ["Date & Time", "datetime"], ["Select", "select"], ["Currency", "currency"], ["Colour", "colour"]],
      input_data: { action: "change->column-options#typeChanged" } %>

    <div data-column-options-target="container" class="hidden">
      <div data-column-options-target="selectOptions" class="hidden">
        <div data-controller="select-source" data-select-source-tables-value="<%= @tables_json %>">
          <%= render "shared/radio_group", form: form, field: :select_source, label: "Select options source",
            selected: @custom_column.select_source,
            options: [["Manual", "manual"], ["Linked to table", "linked"]],
            input_data: { action: "change->select-source#sourceChanged", select_source_target: "sourceInput" } %>

          <div data-select-source-target="manualOptions">
            <% options_errors = @custom_column.errors[:options_text] %>
            <div class="mb-4">
              <%= form.label :options_text, "Options (one per line)", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_area :options_text, rows: 4, placeholder: "Active\nInactive\nPending", class: "block w-full rounded-md border #{options_errors.any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500'} bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1" %>
              <% options_errors.each do |error| %>
                <p class="mt-1 text-sm text-red-600"><%= error %></p>
              <% end %>
            </div>
          </div>

          <div data-select-source-target="linkedOptions" class="hidden">
            <%= render "shared/dropdown", form: form, field: :linked_table_id, label: "Table",
              searchable: true, selected: @custom_column.linked_table_id,
              options: Current.organisation.custom_tables.map { |t| [t.name, t.id] },
              input_data: { action: "change->select-source#tableChanged", select_source_target: "linkedTableInput" } %>

            <% column_options = @custom_column.linked_column ?
                 @custom_column.linked_column.custom_table.custom_columns.map { |c| [c.name, c.id] } : [] %>
            <%= render "shared/dropdown", form: form, field: :linked_column_id, label: "Column",
              searchable: true, selected: @custom_column.linked_column_id,
              options: column_options,
              input_data: { select_source_target: "linkedColumnInput" } %>
          </div>
        </div>
      </div>

      <% regex_enabled = @custom_column.regex_pattern.present? %>
      <div data-column-options-target="regexOptions" class="hidden">
        <div class="mb-4" data-controller="regex-toggle">
          <input type="hidden" value="<%= regex_enabled ? '1' : '0' %>" data-regex-toggle-target="input">
          <div tabindex="0" role="checkbox" aria-checked="<%= regex_enabled %>" aria-label="Custom validation"
            data-action="click->regex-toggle#toggle keydown->regex-toggle#keydown"
            class="inline-flex items-center gap-2 cursor-pointer select-none group">
            <span data-regex-toggle-target="box"
              class="flex shrink-0 items-center justify-center h-5 w-5 rounded border transition-colors
                <%= regex_enabled ? 'bg-gray-900 border-gray-900' : 'bg-white border-gray-300' %>
                group-focus:ring-2 group-focus:ring-gray-500 group-focus:ring-offset-1">
              <svg data-checkmark viewBox="0 0 12 10" fill="none" class="h-3 w-3 text-white <%= 'invisible' unless regex_enabled %>">
                <path d="M1 5.5L4 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="text-sm font-medium text-gray-700">Custom validation</span>
          </div>

          <div data-regex-toggle-target="fields" class="<%= 'hidden' unless regex_enabled %> mt-3 space-y-3">
            <div>
              <%= form.label :regex_pattern, class: "block text-sm font-medium text-gray-700 mb-1" do %>Regex pattern<span class="text-red-500 ml-0.5">*</span><% end %>
              <%= form.text_field :regex_pattern, required: regex_enabled, placeholder: '^\d{3}-\d{4}$', class: "block w-full rounded-md border #{@custom_column.errors[:regex_pattern].any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500'} bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1" %>
              <% @custom_column.errors[:regex_pattern].each do |error| %>
                <p class="mt-1 text-sm text-red-600"><%= error %></p>
              <% end %>
            </div>
            <div>
              <%= form.label :regex_label, class: "block text-sm font-medium text-gray-700 mb-1" do %>Validation name<span class="text-red-500 ml-0.5">*</span><% end %>
              <%= form.text_field :regex_label, required: regex_enabled, placeholder: "Phone Number", class: "block w-full rounded-md border #{@custom_column.errors[:regex_label].any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-gray-500 focus:ring-gray-500'} bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1" %>
              <% @custom_column.errors[:regex_label].each do |error| %>
                <p class="mt-1 text-sm text-red-600"><%= error %></p>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <% if @has_records %>
        <% backfill_mode = params.dig(:custom_column, :backfill_mode) %>
        <% backfill_enabled = backfill_mode.present? && backfill_mode != "none" %>
        <% selected_type = @custom_column.column_type %>
        <% select_options = @custom_column.column_type == "select" ? @custom_column.effective_options : [] %>
        <div class="mb-4" data-controller="backfill"
          data-action="column-options:typeChanged@document->backfill#updateFallbackType turbo:frame-load->backfill#frameLoaded"
          data-backfill-select-options-url-value="<%= backfill_select_options_table_columns_path(@custom_table) %>">
          <input type="hidden" value="<%= backfill_enabled ? '1' : '0' %>" data-backfill-target="input">
          <div tabindex="0" role="checkbox" aria-checked="<%= backfill_enabled %>" aria-label="Backfill existing records"
            data-action="click->backfill#toggle keydown->backfill#keydown"
            class="inline-flex items-center gap-2 cursor-pointer select-none group">
            <span data-backfill-target="box"
              class="flex shrink-0 items-center justify-center h-5 w-5 rounded border transition-colors
                <%= backfill_enabled ? 'bg-gray-900 border-gray-900' : 'bg-white border-gray-300' %>
                group-focus:ring-2 group-focus:ring-gray-500 group-focus:ring-offset-1">
              <svg data-checkmark viewBox="0 0 12 10" fill="none" class="h-3 w-3 text-white <%= 'invisible' unless backfill_enabled %>">
                <path d="M1 5.5L4 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="text-sm font-medium text-gray-700">Backfill existing records</span>
          </div>

          <div data-backfill-target="fields" class="<%= 'hidden' unless backfill_enabled %> mt-3 space-y-3">
            <%= render "shared/radio_group", form: form, field: :backfill_mode, label: "Source type",
              selected: backfill_enabled ? backfill_mode : "fixed",
              options: [["Fixed value", "fixed"], ["Copy from column", "column"]],
              input_data: { action: "change->backfill#modeChanged", backfill_target: "modeInput" } %>

            <div data-backfill-target="fixedSection" class="<%= 'hidden' unless backfill_mode == 'fixed' %>">
              <% backfill_value_errors = @custom_column.errors[:backfill_value] || [] %>
              <div class="mb-4">
                <%= form.label :backfill_value, class: "block text-sm font-medium text-gray-700 mb-1" do %>Value<span class="text-red-500 ml-0.5">*</span><% end %>
                <% border = backfill_value_errors.any? ? "border-red-300 focus:border-red-500 focus:ring-red-500" : "border-gray-300 focus:border-gray-500 focus:ring-gray-500" %>
                <% CustomColumn::COLUMN_TYPES.each do |type| %>
                  <div data-backfill-target="fixedType" data-type="<%= type %>" class="<%= 'hidden' unless type == selected_type %>">
                    <% if type == "select" %>
                      <%= turbo_frame_tag "backfill_value_select_frame" do %>
                        <%= type_input_tag(type, "custom_column[backfill_value]", "backfill_value_#{type}",
                          type == selected_type ? params.dig(:custom_column, :backfill_value) : nil,
                          border: border, select_options: select_options, label: "Value") %>
                      <% end %>
                    <% else %>
                      <%= type_input_tag(type, "custom_column[backfill_value]", "backfill_value_#{type}",
                        type == selected_type ? params.dig(:custom_column, :backfill_value) : nil,
                        border: border, select_options: select_options, label: "Value") %>
                    <% end %>
                  </div>
                <% end %>
                <% backfill_value_errors.each do |error| %>
                  <p class="mt-1 text-sm text-red-600"><%= error %></p>
                <% end %>
              </div>
            </div>

            <div data-backfill-target="columnSection" class="<%= 'hidden' unless backfill_mode == 'column' %>">
              <%= render "shared/dropdown", form: form, field: :backfill_column_id, label: "Source column",
                required: true, searchable: true, selected: params.dig(:custom_column, :backfill_column_id),
                options: @existing_columns.map { |c| [c.name, c.id] } %>

              <% backfill_fallback_errors = @custom_column.errors[:backfill_fallback] || [] %>
              <div class="mb-4">
                <%= form.label :backfill_fallback, "Fallback value", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <% fallback_border = backfill_fallback_errors.any? ? "border-red-300 focus:border-red-500 focus:ring-red-500" : "border-gray-300 focus:border-gray-500 focus:ring-gray-500" %>
                <% CustomColumn::COLUMN_TYPES.each do |type| %>
                  <div data-backfill-target="fallbackType" data-type="<%= type %>" class="<%= 'hidden' unless type == selected_type %>">
                    <% if type == "select" %>
                      <%= turbo_frame_tag "backfill_fallback_select_frame" do %>
                        <%= type_input_tag(type, "custom_column[backfill_fallback]", "backfill_fallback_#{type}",
                          type == selected_type ? params.dig(:custom_column, :backfill_fallback) : nil,
                          border: fallback_border, select_options: select_options, label: "Fallback value") %>
                      <% end %>
                    <% else %>
                      <%= type_input_tag(type, "custom_column[backfill_fallback]", "backfill_fallback_#{type}",
                        type == selected_type ? params.dig(:custom_column, :backfill_fallback) : nil,
                        border: fallback_border, select_options: select_options, label: "Fallback value") %>
                    <% end %>
                  </div>
                <% end %>
                <p class="mt-1 text-sm text-gray-500">If a source value is incompatible with this column type, the fallback is used instead.</p>
                <% backfill_fallback_errors.each do |error| %>
                  <p class="mt-1 text-sm text-red-600"><%= error %></p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <div data-column-options-target="required">
        <%= render "shared/checkbox", form: form, field: :required, label: "Required column" %>
      </div>
      <%= render "shared/checkbox", form: form, field: :show_on_preview, label: "Show on preview" %>
    </div>

    <div class="flex items-center gap-3">
      <%= render "shared/button", label: "Add column", form: form %>
      <%= render "shared/button", style: "ghost", label: "Cancel", href: edit_table_path(@custom_table) %>
    </div>
  <% end %>
</div>
