<%# locals: (section:, record:) %>
<% section_frame_id = "related_#{section.relationship.id}_#{section.suffix}_section" %>
<% table_frame_id = "related_#{section.relationship.id}_#{section.suffix}_frame" %>
<% search_param = "rq_#{section.relationship.id}_#{section.suffix}" %>
<% reload_frame_id = section.self_referential ? "related_#{section.relationship.id}" : section_frame_id %>

<%= turbo_frame_tag section_frame_id do %>
  <section class="space-y-3">
    <h2 class="text-lg font-semibold text-gray-900"><%= section.label %></h2>

    <% linked_record_for = ->(link) {
      if section.symmetric
        link.source_record_id == record.id ? link.target_record : link.source_record
      else
        section.is_source ? link.target_record : link.source_record
      end
    } %>

    <% columns = section.display_columns.each_with_index.map do |column, i|
      col = {
        header: column.name,
        accessor: ->(link) {
          rec = linked_record_for.call(link)
          rec.custom_values.detect { |v| v.custom_column_id == column.id }&.value.presence || "â€”"
        }
      }
      col[:link] = ->(link) { table_record_path(section.target_table, linked_record_for.call(link)) } if i == 0
      col
    end %>

    <div class="flex items-center justify-between mb-2">
      <div class="w-full max-w-sm">
        <%= form_with url: table_record_path(@custom_table, record), method: :get, data: { turbo_frame: table_frame_id, turbo_action: "advance" } do |form| %>
          <div class="relative">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
              <%= lucide_icon("search", class: "h-4 w-4 text-gray-400") %>
            </div>
            <%= form.search_field search_param, value: params[search_param], placeholder: "Search records...",
              class: "w-full rounded-md border border-gray-300 bg-white pl-9 pr-3 py-2 text-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500", oninput: "this.form.requestSubmit()" %>
          </div>
        <% end %>
      </div>
      <div>
        <% if section.accepts_more && !(@custom_table.protected? && !edit_mode?) %>
          <%= form_with model: CustomRecordLink.new, url: record_links_path, data: { turbo_frame: reload_frame_id } do |form| %>
            <%= form.hidden_field :custom_relationship_id, value: section.relationship.id %>
            <% if section.is_source %>
              <%= form.hidden_field :source_record_id, value: record.id %>
            <% else %>
              <%= form.hidden_field :target_record_id, value: record.id %>
            <% end %>
            <% link_field = section.is_source ? :target_record_id : :source_record_id %>

            <div data-controller="dropdown" data-dropdown-autosubmit-value="true" class="relative">
              <%= form.hidden_field link_field, data: { dropdown_target: "input" } %>

              <button type="button" data-action="dropdown#toggle" data-dropdown-target="button"
                class="inline-flex items-center gap-1.5 px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-md hover:bg-gray-800 transition-colors cursor-pointer select-none">
                <%= lucide_icon("plus", class: "h-4 w-4") %>
                Link record
              </button>

              <div data-dropdown-target="menu" class="hidden absolute right-0 z-10 mt-1 w-64 rounded-md border border-gray-200 bg-white shadow-lg max-h-60 overflow-y-auto">
                <% if section.available_records.any? %>
                  <div class="sticky top-0 bg-white border-b border-gray-200 p-1.5">
                    <input type="text" data-dropdown-target="search" data-action="input->dropdown#filter"
                      placeholder="Search..." class="w-full rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500" />
                  </div>
                  <div class="py-1">
                    <% section.available_records.each do |r| %>
                      <button type="button" data-action="dropdown#select" data-value="<%= r.id %>" data-label="<%= r.display_name %>"
                        class="flex items-center w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer select-none">
                        <span><%= r.display_name %></span>
                      </button>
                    <% end %>
                  </div>
                <% else %>
                  <div class="px-3 py-4 text-sm text-gray-500 text-center">
                    No records available to link.
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%= turbo_frame_tag table_frame_id do %>
      <% table_protected = @custom_table.protected? && !edit_mode? %>
      <%= render "shared/table",
        columns: columns,
        rows: section.record_links,
        actions: table_protected ? [ :view ] : [ :view, :destroy ],
        view_path: ->(link) { table_record_path(section.target_table, linked_record_for.call(link)) },
        destroy_path: ->(link) { record_link_path(link) },
        destroy_label: "Unlink",
        destroy_confirm: "Unlink this record?",
        destroy_frame: reload_frame_id,
        frame_id: nil,
        pagination_frame: table_frame_id,
        pagy: section.pagy,
        page_param: :"rp_#{section.relationship.id}_#{section.suffix}" %>
    <% end %>
  </section>
<% end %>
