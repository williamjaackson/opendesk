<div class="space-y-8">
  <%= form_with model: @custom_table, url: @custom_table.persisted? ? table_path(@custom_table) : tables_path, html: { novalidate: true } do |form| %>
    <%= render "shared/form_input", form: form, field: :name, label: "Table name", options: { required: true, autofocus: true, placeholder: "e.g. Contacts, Deals, Projects" } %>
    <%= form.hidden_field :table_group_id %>
    <div class="flex items-center gap-3">
      <%= render "shared/button", label: @custom_table.persisted? ? "Save changes" : "Create table", form: form %>
      <% if local_assigns[:cancel_path] %>
        <%= render "shared/button", style: "ghost", label: "Cancel", href: cancel_path %>
      <% end %>
    </div>
  <% end %>

  <% if @custom_table.persisted? %>
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Columns</h2>

      <%= render "shared/table",
        columns: [
          { header: "Name", accessor: ->(c) {
            tag.span(data: { column_name: true }) do
              concat c.name
              if @pagy_columns.page == 1 && c == @columns.first
                concat " ".html_safe
                concat tag.span("Primary", data: { primary_badge: true }, class: "ml-2 inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600")
              end
            end
          }, link: ->(c) { edit_table_column_path(@custom_table, c) } },
          { header: "Type", accessor: :column_type },
          { header: "Required", accessor: ->(c) { c.required? ? "Yes" : "No" } },
          { header: "Preview", accessor: ->(c) { c.show_on_preview? ? "Yes" : "No" } }
        ],
        rows: @columns,
        actions: builder_mode? ? [ :edit, :destroy ] : [],
        edit_path: ->(c) { edit_table_column_path(@custom_table, c) },
        destroy_path: ->(c) { table_column_path(@custom_table, c) },
        destroy_confirm: "This will delete all values for this column and any records left empty. Continue?",
        search_url: edit_table_path(@custom_table),
        create_url: builder_mode? ? new_table_column_path(@custom_table) : nil,
        create_label: "Add column",
        sortable_url: builder_mode? ? reorder_table_columns_path(@custom_table) : nil,
        highlight_create: @columns.empty?,
        pagy: @pagy_columns,
        page_param: :columns_page %>
    </section>

    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Relationships</h2>

      <%= render "shared/table",
        columns: [
          { header: "Name", accessor: ->(r) { r.source_table_id == @custom_table.id ? r.name : r.inverse_name }, link: ->(r) { edit_table_relationship_path(@custom_table, r) } },
          { header: "Related table", accessor: ->(r) { r.source_table_id == @custom_table.id ? r.target_table.name : r.source_table.name } },
          { header: "Kind", accessor: ->(r) {
            if r.source_table_id == @custom_table.id
              r.kind.humanize
            else
              case r.kind
              when "one_to_one" then "One to one"
              when "one_to_many" then "Many to one"
              when "many_to_one" then "One to many"
              when "many_to_many" then "Many to many"
              end
            end
          } }
        ],
        rows: @relationships,
        actions: builder_mode? ? [ :edit, :destroy ] : [],
        edit_path: ->(r) { edit_table_relationship_path(@custom_table, r) },
        destroy_path: ->(r) { table_relationship_path(@custom_table, r) },
        destroy_confirm: "This will remove the relationship and all record links. Continue?",
        search_url: edit_table_path(@custom_table),
        search_param: :relationship_query,
        frame_id: "relationships_table_frame",
        create_url: builder_mode? ? new_table_relationship_path(@custom_table) : nil,
        create_label: "Add relationship",
        sortable_url: builder_mode? ? reorder_table_relationships_path(@custom_table) : nil,
        pagy: @pagy_relationships,
        page_param: :relationships_page %>
    </section>

    <% if builder_mode? %>
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Data</h2>
        <p class="text-sm text-gray-500 mb-4">Export table data to CSV or import records from a CSV file.</p>
        <div class="flex items-center gap-3">
          <%= link_to export_table_path(@custom_table), class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition-colors cursor-pointer select-none" do %>
            <%= lucide_icon("download", class: "h-4 w-4") %>
            Export
          <% end %>
          <%= link_to new_table_csv_import_path(@custom_table), class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition-colors cursor-pointer select-none" do %>
            <%= lucide_icon("upload", class: "h-4 w-4") %>
            Import
          <% end %>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Protection</h2>
        <p class="text-sm text-gray-500 mb-4">Protected tables are read-only. Records cannot be added, edited, or deleted unless builder mode is enabled.</p>

        <%= button_to toggle_protection_table_path(@custom_table), method: :patch, form: { data: { turbo_frame: "_top" } }, class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md border transition-colors cursor-pointer select-none #{@custom_table.protected? ? 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50' : 'border-amber-300 text-amber-700 bg-amber-50 hover:bg-amber-100'}" do %>
          <%= lucide_icon(@custom_table.protected? ? "lock-open" : "lock", class: "h-4 w-4") %>
          <%= @custom_table.protected? ? "Unprotect table" : "Protect table" %>
        <% end %>
      </section>

      <%= render "shared/danger_zone",
        description: "Deleting this table will permanently remove all its columns and records.",
        path: table_path(@custom_table),
        button_label: "Delete table",
        confirm: "Are you sure you want to delete this table? This cannot be undone." %>
    <% end %>
  <% end %>
</div>
