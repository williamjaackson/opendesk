<div class="space-y-8">
  <%= form_with model: @custom_table, url: @custom_table.persisted? ? table_path(@custom_table) : tables_path do |form| %>
    <%= render "shared/form_input", form: form, field: :name, label: "Table name", options: { required: true, autofocus: true, placeholder: "e.g. Contacts, Deals, Projects" } %>
    <%= form.hidden_field :table_group_id %>
    <%= render "shared/button", label: @custom_table.persisted? ? "Save changes" : "Create table", form: form %>
  <% end %>

  <% if @custom_table.persisted? %>
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Fields</h2>

      <%= render "shared/table",
        columns: [
          { header: "Name", accessor: ->(f) {
            tag.span(data: { field_name: true }) do
              concat f.name
              if @pagy_fields.page == 1 && f == @fields.first
                concat " ".html_safe
                concat tag.span("Primary", data: { primary_badge: true }, class: "ml-2 inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600")
              end
            end
          } },
          { header: "Type", accessor: :field_type },
          { header: "Required", accessor: ->(f) { f.required? ? "Yes" : "No" } },
          { header: "Preview", accessor: ->(f) { f.show_on_preview? ? "Yes" : "No" } }
        ],
        rows: @fields,
        actions: edit_mode? ? [ :edit, :destroy ] : [],
        edit_path: ->(f) { edit_table_field_path(@custom_table, f) },
        destroy_path: ->(f) { table_field_path(@custom_table, f) },
        destroy_confirm: "This will delete all values for this field and any records left empty. Continue?",
        search_url: edit_table_path(@custom_table),
        create_url: edit_mode? ? new_table_field_path(@custom_table) : nil,
        create_label: "Add field",
        sortable_url: edit_mode? ? reorder_table_fields_path(@custom_table) : nil,
        pagy: @pagy_fields,
        page_param: :fields_page %>
    </section>

    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Relationships</h2>

      <%= render "shared/table",
        columns: [
          { header: "Name", accessor: ->(r) { r.source_table_id == @custom_table.id ? r.name : r.inverse_name } },
          { header: "Related table", accessor: ->(r) { r.source_table_id == @custom_table.id ? r.target_table.name : r.source_table.name } },
          { header: "Kind", accessor: ->(r) {
            if r.source_table_id == @custom_table.id
              r.kind.humanize
            else
              case r.kind
              when "one_to_one" then "One to one"
              when "one_to_many" then "Many to one"
              when "many_to_one" then "One to many"
              when "many_to_many" then "Many to many"
              end
            end
          } }
        ],
        rows: @relationships,
        actions: edit_mode? ? [ :edit, :destroy ] : [],
        edit_path: ->(r) { edit_table_relationship_path(@custom_table, r) },
        destroy_path: ->(r) { table_relationship_path(@custom_table, r) },
        destroy_confirm: "This will remove the relationship and all record links. Continue?",
        search_url: edit_table_path(@custom_table),
        search_param: :relationship_query,
        frame_id: "relationships_table_frame",
        create_url: edit_mode? ? new_table_relationship_path(@custom_table) : nil,
        create_label: "Add relationship",
        pagy: @pagy_relationships,
        page_param: :relationships_page %>
    </section>

    <% if edit_mode? %>
      <%= render "shared/danger_zone",
        description: "Deleting this table will permanently remove all its fields and records.",
        path: table_path(@custom_table),
        button_label: "Delete table",
        confirm: "Are you sure you want to delete this table? This cannot be undone." %>
    <% end %>
  <% end %>
</div>
